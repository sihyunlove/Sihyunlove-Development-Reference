---
title: JNI 사용법
date: 2021-01-15
tags: [JAVA]
excerpt: Java, JNI
---

## DLL을 사용하기 위한 자바 코드 생성
* 아래의 HelloWorld.java 코드와 같은 코드를 생성한다. 여기서 DLL 의 함수(메소드)는  native 메소드인 print(), view()  메소드이다.

* HelloWorld.java

```java
package com.mptrance.test;

public class HelloWorld {
    private native void print();
    private native void view();
    public static void main(String[] args) {
        try {
            new HelloWorld().print();
            new HelloWorld().view();
        } 
        catch (Exception e) {
            e.printStackTrace();
        }
    }
    static {
        // 라이브러리 이름 입력 시 확장자는 빼고 입력한다.
        System.loadLibrary("/lib/Hello");
    }
}

```

## make header file
* 컴파일한 com/mptrance/test/HelloWorld.class를 javah 를 이용하여 .h(헤더파일) 을 만들어 주어야 한다.

```shell
javah com.mptrance.test.HelloWorld com_mptrance_test_HelloWorld.h

```

* HellowWorld.h(생성된 jni header)

```cpp
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class com_mptrance_test_HelloWorld */
#ifndef _Included_com_mptrance_test_HelloWorld
#define _Included_com_mptrance_test_HelloWorld
#ifdef __cplusplus
extern "C" {
#endif
/*
* Class:     com_mptrance_test_HelloWorld
* Method:    print
* Signature: ()V
*/
JNIEXPORT void JNICALL Java_com_mptrance_test_HelloWorld_print(JNIEnv *, jobject);
/*
* Class:     com_mptrance_test_HelloWorld
* Method:    view
* Signature: ()V
*/
JNIEXPORT void JNICALL Java_com_mptrance_test_HelloWorld_view(JNIEnv *, jobject);
#ifdef __cplusplus
}
#endif
#endif

```

## make jni cpp
* 위에서 생성한 jni header는 구현부가 없다. 따라서 작성을 해야 한다.
* HellowWorld.cpp

```cpp
#include <stdio.h>
#include "HelloWorld.h"

JNIEXPORT void JNICALL Java_com_mptrance_test_HelloWorld_print(JNIEnv *env, jobject cls){
    printf("Hello JackyLim");
}
JNIEXPORT void JNICALL Java_com_mptrance_test_HelloWorld_view (JNIEnv *env, jobject cls){
    printf("Hello JackyLim View");
}

```

## C/C++ 컴파일(dll 생성)
### for Windows
* Visual Studio 명령 프롬프트에서 다음을 입력합니다.

```cmd
cl -EHsc /GR -I%JAVA_HOME%\include -I%JAVA_HOME%\include\win32 HelloWorld.c -LD -FeHello.dll
cl –GX / GR -I%JAVA_HOME%\include -I%JAVA_HOME%\include\win32 HelloWorld.c -LD -FeHello.dll

# -I :  해당 디렉토리의 DLL 을 로드 하는데 JDK(JRE)에 들어 있는 JNI 관련 DLL 을 로드 합니다.
# -GX : 옵션의 경우에는 Visual Studio 2008의 경우에는 –Ehsc 를 사용하기를 권장하고 있으며 이후 버전에서는 사라진다고 합니다.

```

### for UNIX

```cmd
g++ -c –fPIC –I$JAVA_HOME/include –I$JAVA_HOME/include/linux HelloNative.cpp
g++ -shared –o libHelloNative.so HelloNative.o

# Standard Sun C++ 컴파일러를 사용할 경우
CC –G –I$JAVA_HOME/include –I$JAVA_HOME/include/solaris HelloNative.cpp –o libHelloNative.so

```

## Package와 header file
* Java_com_mptrance_test_HelloWorld_view 는  Java 의 com.mptrance.test.HelloWorld.view() 메소드를 가리키는 것입니다.
만약 앞에서의 헤더파일을 이용해 C/C++로 구현한 후 Java 의 HelloWorld 를 Package 구조가 다르게 작성하여 사용하게 되면 다음과 같은 에러가 발생 할 수 있다.

```shell
Exception in thread "main" java.lang.UnsatisfiedLinkError: com.HelloWorld.print()V
at HelloWorld.print(Native Method)
at HelloWorld.main(HelloWorld.java:8)

```

* 앞의 에러는 HelloWorld.java 를 com.HelloWorld Package의 구조를 가지고 있다는 것이다. 그러나  DLL 은 com.mptrance.test.HelloWorld 였기 때문에 해당 메소드에 대한 연결이 되지 않아서 에러가 발생 하게 된다.
